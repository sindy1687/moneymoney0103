<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•è³‡ç›®æ¨™è¿½è¹¤æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button.success {
            background-color: #28a745;
        }
        .button.warning {
            background-color: #ffc107;
            color: #212529;
        }
        .button.danger {
            background-color: #dc3545;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .data-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        .goal-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .goal-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .goal-item {
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ æŠ•è³‡ç›®æ¨™è¿½è¹¤æ¸¬è©¦</h1>
    
    <div class="container">
        <h3>åŸºç¤æª¢æŸ¥</h3>
        <button class="button" onclick="checkBasicFunction()">æª¢æŸ¥åŸºç¤åŠŸèƒ½</button>
        <button class="button" onclick="checkGoalTracking()">æª¢æŸ¥ç›®æ¨™è¿½è¹¤å‡½æ•¸</button>
        <div id="basicStatus"></div>
    </div>
    
    <div class="container">
        <h3>æ•¸æ“šç®¡ç†</h3>
        <button class="button" onclick="loadTestData()">è¼‰å…¥æ¸¬è©¦æ•¸æ“š</button>
        <button class="button" onclick="loadDefaultGoals()">è¼‰å…¥é è¨­ç›®æ¨™</button>
        <button class="button" onclick="showCurrentData()">é¡¯ç¤ºç•¶å‰æ•¸æ“š</button>
        <button class="button danger" onclick="clearData()">æ¸…é™¤æ•¸æ“š</button>
        <div id="dataStatus"></div>
        <div id="dataDisplay"></div>
    </div>
    
    <div class="container">
        <h3>ç›®æ¨™è¿½è¹¤æ¸¬è©¦</h3>
        <button class="button success" onclick="testGoalTracking()">æ¸¬è©¦ç›®æ¨™è¿½è¹¤</button>
        <button class="button" onclick="testWithModal()">ä½¿ç”¨å½ˆçª—æ¸¬è©¦</button>
        <button class="button" onclick="testIndividualGoals()">æ¸¬è©¦å€‹åˆ¥ç›®æ¨™</button>
        <div id="trackingStatus"></div>
        <div id="trackingResult"></div>
    </div>
    
    <div class="container">
        <h3>æ•´åˆæ¸¬è©¦</h3>
        <button class="button" onclick="testManagerIntegration()">æ¸¬è©¦ç®¡ç†å™¨æ•´åˆ</button>
        <button class="button" onclick="simulateButtonClick()">æ¨¡æ“¬æŒ‰éˆ•é»æ“Š</button>
        <div id="integrationStatus"></div>
    </div>

    <!-- ç›®æ¨™è¿½è¹¤å½ˆçª— -->
    <div class="modal" id="goalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¯ æŠ•è³‡ç›®æ¨™è¿½è¹¤</h3>
                <button class="close-btn" onclick="closeModal()">âœ•</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="js/investment-analysis.js"></script>
    <script src="js/investment-analysis-integration.js"></script>

    <script>
        function updateStatus(elementId, message, type = 'success') {
            const statusDiv = document.getElementById(elementId);
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function updateDataDisplay(data) {
            const displayDiv = document.getElementById('dataDisplay');
            displayDiv.innerHTML = `<div class="data-display">${JSON.stringify(data, null, 2)}</div>`;
        }

        function checkBasicFunction() {
            try {
                let html = '';
                
                // æª¢æŸ¥ InvestmentAnalysis æ¨¡çµ„
                if (typeof InvestmentAnalysis === 'undefined') {
                    throw new Error('InvestmentAnalysis æ¨¡çµ„æœªè¼‰å…¥');
                }
                html += '<div class="status success">âœ… InvestmentAnalysis æ¨¡çµ„å·²è¼‰å…¥</div>';
                
                // æª¢æŸ¥ trackInvestmentGoals å‡½æ•¸
                if (typeof InvestmentAnalysis.trackInvestmentGoals !== 'function') {
                    throw new Error('trackInvestmentGoals å‡½æ•¸ä¸å­˜åœ¨');
                }
                html += '<div class="status success">âœ… trackInvestmentGoals å‡½æ•¸å­˜åœ¨</div>';
                
                // æª¢æŸ¥ InvestmentAnalysisManager
                if (typeof investmentAnalysisManager === 'undefined') {
                    throw new Error('InvestmentAnalysisManager æœªå‰µå»º');
                }
                html += '<div class="status success">âœ… InvestmentAnalysisManager å·²å‰µå»º</div>';
                
                // æª¢æŸ¥ç®¡ç†å™¨ç‹€æ…‹
                html += `<div class="data-display">ç®¡ç†å™¨ç‹€æ…‹: ${JSON.stringify({
                    isInitialized: investmentAnalysisManager.isInitialized,
                    holdingsCount: investmentAnalysisManager.currentHoldings.length,
                    goalsCount: investmentAnalysisManager.currentGoals.length
                }, null, 2)}</div>`;
                
                updateStatus('basicStatus', html);
                
            } catch (error) {
                updateStatus('basicStatus', 'âŒ åŸºç¤åŠŸèƒ½æª¢æŸ¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        function checkGoalTracking() {
            try {
                if (typeof InvestmentAnalysis.trackInvestmentGoals !== 'function') {
                    throw new Error('trackInvestmentGoals å‡½æ•¸ä¸å­˜åœ¨');
                }
                
                // æ¸¬è©¦ç©ºç›®æ¨™
                const emptyResult = InvestmentAnalysis.trackInvestmentGoals([], {});
                if (emptyResult !== null) {
                    throw new Error('ç©ºç›®æ¨™æ‡‰è©²è¿”å› null');
                }
                
                updateStatus('basicStatus', 'âœ… ç›®æ¨™è¿½è¹¤å‡½æ•¸æª¢æŸ¥é€šé');
                
            } catch (error) {
                updateStatus('basicStatus', 'âŒ ç›®æ¨™è¿½è¹¤å‡½æ•¸æª¢æŸ¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        function loadTestData() {
            // è¼‰å…¥æŠ•è³‡è¨˜éŒ„
            const investmentRecords = [
                {
                    type: 'buy',
                    stockCode: '0056',
                    stockName: 'å…ƒå¤§å°ç£50',
                    date: '2024-01-15',
                    price: 150.5,
                    shares: 1000,
                    fee: 100
                },
                {
                    type: 'buy',
                    stockCode: '0050',
                    stockName: 'å…ƒå¤§é«˜è‚¡æ¯',
                    date: '2024-02-20',
                    price: 120.3,
                    shares: 500,
                    fee: 80
                }
            ];
            
            // è¼‰å…¥ç•¶å‰åƒ¹æ ¼
            const currentPrices = {
                '0056': 155.2,
                '0050': 125.8
            };
            
            // è¼‰å…¥æ¸¬è©¦ç›®æ¨™
            const testGoals = [
                {
                    id: 'goal1',
                    name: 'é€€ä¼‘åŸºé‡‘',
                    type: 'retirement',
                    targetAmount: 1000000,
                    targetDate: '2040-12-31',
                    duration: 240,
                    monthlyContribution: 10000
                },
                {
                    id: 'goal2',
                    name: 'è³¼å±‹åŸºé‡‘',
                    type: 'house',
                    targetAmount: 2000000,
                    targetDate: '2030-12-31',
                    duration: 84,
                    monthlyContribution: 15000
                },
                {
                    id: 'goal3',
                    name: 'æ•™è‚²åŸºé‡‘',
                    type: 'education',
                    targetAmount: 500000,
                    targetDate: '2028-12-31',
                    duration: 60,
                    monthlyContribution: 5000
                }
            ];
            
            localStorage.setItem('investmentRecords', JSON.stringify(investmentRecords));
            localStorage.setItem('stockCurrentPrices', JSON.stringify(currentPrices));
            localStorage.setItem('investmentGoals', JSON.stringify(testGoals));
            
            updateStatus('dataStatus', 'âœ… æ¸¬è©¦æ•¸æ“šå·²è¼‰å…¥');
            
            // é‡æ–°è¼‰å…¥ç®¡ç†å™¨æ•¸æ“š
            if (typeof investmentAnalysisManager !== 'undefined') {
                investmentAnalysisManager.loadData();
                updateStatus('dataStatus', 'âœ… ç®¡ç†å™¨æ•¸æ“šå·²æ›´æ–°');
            }
        }

        function loadDefaultGoals() {
            if (typeof investmentAnalysisManager !== 'undefined') {
                investmentAnalysisManager.currentGoals = investmentAnalysisManager.getDefaultGoals();
                localStorage.setItem('investmentGoals', JSON.stringify(investmentAnalysisManager.currentGoals));
                updateStatus('dataStatus', 'âœ… é è¨­ç›®æ¨™å·²è¼‰å…¥');
            } else {
                updateStatus('dataStatus', 'âŒ InvestmentAnalysisManager æœªå®šç¾©', 'error');
            }
        }

        function showCurrentData() {
            try {
                const investmentRecords = JSON.parse(localStorage.getItem('investmentRecords') || '[]');
                const investmentGoals = JSON.parse(localStorage.getItem('investmentGoals') || '[]');
                const stockCurrentPrices = JSON.parse(localStorage.getItem('stockCurrentPrices') || '{}');
                
                updateDataDisplay({
                    æŠ•è³‡è¨˜éŒ„: investmentRecords,
                    æŠ•è³‡ç›®æ¨™: investmentGoals,
                    ç•¶å‰åƒ¹æ ¼: stockCurrentPrices
                });
                
                updateStatus('dataStatus', 'âœ… ç•¶å‰æ•¸æ“šé¡¯ç¤ºå®Œæˆ');
                
            } catch (error) {
                updateStatus('dataStatus', 'âŒ é¡¯ç¤ºæ•¸æ“šå¤±æ•—: ' + error.message, 'error');
            }
        }

        function clearData() {
            localStorage.removeItem('investmentRecords');
            localStorage.removeItem('investmentGoals');
            localStorage.removeItem('stockCurrentPrices');
            
            if (typeof investmentAnalysisManager !== 'undefined') {
                investmentAnalysisManager.currentHoldings = [];
                investmentAnalysisManager.currentGoals = [];
                investmentAnalysisManager.portfolioAnalysis = null;
                investmentAnalysisManager.goalTracking = null;
            }
            
            updateStatus('dataStatus', 'âœ… æ•¸æ“šå·²æ¸…é™¤');
            updateDataDisplay('æ•¸æ“šå·²æ¸…é™¤');
        }

        function testGoalTracking() {
            try {
                if (typeof investmentAnalysisManager === 'undefined') {
                    throw new Error('InvestmentAnalysisManager æœªå®šç¾©');
                }
                
                // é‡æ–°è¼‰å…¥æ•¸æ“š
                investmentAnalysisManager.loadData();
                
                if (investmentAnalysisManager.currentGoals.length === 0) {
                    updateStatus('trackingStatus', 'âš ï¸ æ²’æœ‰ç›®æ¨™æ•¸æ“šï¼Œè«‹å…ˆè¼‰å…¥æ¸¬è©¦æ•¸æ“š', 'warning');
                    return;
                }
                
                // åŸ·è¡ŒæŠ•è³‡çµ„åˆåˆ†æ
                const portfolioAnalysis = InvestmentAnalysis.analyzePortfolio(investmentAnalysisManager.currentHoldings);
                
                // åŸ·è¡Œç›®æ¨™è¿½è¹¤
                const goalTracking = InvestmentAnalysis.trackInvestmentGoals(investmentAnalysisManager.currentGoals, portfolioAnalysis);
                
                if (!goalTracking) {
                    throw new Error('ç›®æ¨™è¿½è¹¤è¿”å› null');
                }
                
                updateStatus('trackingStatus', 'âœ… ç›®æ¨™è¿½è¹¤æ¸¬è©¦æˆåŠŸ');
                updateDataDisplay(goalTracking);
                
            } catch (error) {
                updateStatus('trackingStatus', 'âŒ ç›®æ¨™è¿½è¹¤æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
                console.error('ç›®æ¨™è¿½è¹¤éŒ¯èª¤:', error);
            }
        }

        function testWithModal() {
            try {
                if (typeof investmentAnalysisManager === 'undefined') {
                    throw new Error('InvestmentAnalysisManager æœªå®šç¾©');
                }
                
                // é‡æ–°è¼‰å…¥æ•¸æ“š
                investmentAnalysisManager.loadData();
                
                if (investmentAnalysisManager.currentGoals.length === 0) {
                    updateStatus('trackingStatus', 'âš ï¸ æ²’æœ‰ç›®æ¨™æ•¸æ“šï¼Œè«‹å…ˆè¼‰å…¥æ¸¬è©¦æ•¸æ“š', 'warning');
                    return;
                }
                
                // åŸ·è¡Œç›®æ¨™è¿½è¹¤
                const portfolioAnalysis = InvestmentAnalysis.analyzePortfolio(investmentAnalysisManager.currentHoldings);
                const goalTracking = InvestmentAnalysis.trackInvestmentGoals(investmentAnalysisManager.currentGoals, portfolioAnalysis);
                
                // é¡¯ç¤ºåœ¨å½ˆçª—ä¸­
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = renderGoalTracking(goalTracking);
                
                document.getElementById('goalModal').style.display = 'flex';
                updateStatus('trackingStatus', 'âœ… å½ˆçª—æ¸¬è©¦æˆåŠŸ');
                
            } catch (error) {
                updateStatus('trackingStatus', 'âŒ å½ˆçª—æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
                console.error('å½ˆçª—éŒ¯èª¤:', error);
            }
        }

        function testIndividualGoals() {
            try {
                if (typeof investmentAnalysisManager === 'undefined') {
                    throw new Error('InvestmentAnalysisManager æœªå®šç¾©');
                }
                
                investmentAnalysisManager.loadData();
                
                if (investmentAnalysisManager.currentGoals.length === 0) {
                    updateStatus('trackingStatus', 'âš ï¸ æ²’æœ‰ç›®æ¨™æ•¸æ“šï¼Œè«‹å…ˆè¼‰å…¥æ¸¬è©¦æ•¸æ“š', 'warning');
                    return;
                }
                
                const portfolioAnalysis = InvestmentAnalysis.analyzePortfolio(investmentAnalysisManager.currentHoldings);
                const results = [];
                
                investmentAnalysisManager.currentGoals.forEach(goal => {
                    const tracking = InvestmentAnalysis.trackSingleGoal(goal, portfolioAnalysis);
                    results.push({
                        ç›®æ¨™åç¨±: goal.name,
                        è¿½è¹¤çµæœ: tracking
                    });
                });
                
                updateStatus('trackingStatus', 'âœ… å€‹åˆ¥ç›®æ¨™æ¸¬è©¦å®Œæˆ');
                updateDataDisplay(results);
                
            } catch (error) {
                updateStatus('trackingStatus', 'âŒ å€‹åˆ¥ç›®æ¨™æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            }
        }

        function testManagerIntegration() {
            try {
                if (typeof investmentAnalysisManager === 'undefined') {
                    throw new Error('InvestmentAnalysisManager æœªå®šç¾©');
                }
                
                // æª¢æŸ¥åˆå§‹åŒ–
                if (!investmentAnalysisManager.isInitialized) {
                    investmentAnalysisManager.init();
                }
                
                // æª¢æŸ¥æ•¸æ“šè¼‰å…¥
                investmentAnalysisManager.loadData();
                
                // æª¢æŸ¥ç›®æ¨™è¿½è¹¤æ–¹æ³•
                if (typeof investmentAnalysisManager.showGoalTracking !== 'function') {
                    throw new Error('showGoalTracking æ–¹æ³•ä¸å­˜åœ¨');
                }
                
                updateStatus('integrationStatus', 'âœ… ç®¡ç†å™¨æ•´åˆæ¸¬è©¦æˆåŠŸ');
                
            } catch (error) {
                updateStatus('integrationStatus', 'âŒ ç®¡ç†å™¨æ•´åˆæ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            }
        }

        function simulateButtonClick() {
            try {
                if (typeof investmentAnalysisManager === 'undefined') {
                    throw new Error('InvestmentAnalysisManager æœªå®šç¾©');
                }
                
                // æ¨¡æ“¬é»æ“Šç›®æ¨™è¿½è¹¤æŒ‰éˆ•
                investmentAnalysisManager.showGoalTracking();
                updateStatus('integrationStatus', 'âœ… æ¨¡æ“¬æŒ‰éˆ•é»æ“ŠæˆåŠŸ');
                
                // 3ç§’å¾Œè‡ªå‹•é—œé–‰
                setTimeout(() => {
                    investmentAnalysisManager.hideGoalTracking();
                    updateStatus('integrationStatus', 'âœ… å½ˆçª—å·²è‡ªå‹•é—œé–‰');
                }, 3000);
                
            } catch (error) {
                updateStatus('integrationStatus', 'âŒ æ¨¡æ“¬æŒ‰éˆ•é»æ“Šå¤±æ•—: ' + error.message, 'error');
            }
        }

        function renderGoalTracking(tracking) {
            let html = '<h4>ğŸ¯ æŠ•è³‡ç›®æ¨™è¿½è¹¤çµæœ</h4>';
            
            // æ¦‚æ³
            html += '<div class="goal-card">';
            html += '<h5>ğŸ“Š ç›®æ¨™æ¦‚æ³</h5>';
            html += '<div class="goal-info">';
            html += `<div class="goal-item"><span>ç¸½ç›®æ¨™æ•¸:</span><span>${tracking.overview.totalGoals}</span></div>`;
            html += `<div class="goal-item"><span>å·²å®Œæˆ:</span><span>${tracking.overview.completedGoals}</span></div>`;
            html += `<div class="goal-item"><span>é€²è¡Œä¸­:</span><span>${tracking.overview.inProgressGoals}</span></div>`;
            html += `<div class="goal-item"><span>æ•´é«”é€²åº¦:</span><span>${Math.round(tracking.overview.totalCurrentAmount / tracking.overview.totalTargetAmount * 100)}%</span></div>`;
            html += '</div>';
            html += '</div>';
            
            // å€‹åˆ¥ç›®æ¨™
            html += '<h5>ğŸ¯ å€‹åˆ¥ç›®æ¨™</h5>';
            tracking.goals.forEach(goal => {
                html += '<div class="goal-card">';
                html += `<div class="goal-header">
                    <strong>${goal.name}</strong>
                    <span>${goal.status === 'completed' ? 'âœ… å·²å®Œæˆ' : goal.status === 'in_progress' ? 'ğŸ”„ é€²è¡Œä¸­' : 'â¸ï¸ æœªé–‹å§‹'}</span>
                </div>`;
                html += `<div class="progress-bar">
                    <div class="progress-fill" style="width: ${goal.progress}%"></div>
                </div>`;
                html += '<div class="goal-info">';
                html += `<div class="goal-item"><span>ç›®æ¨™é‡‘é¡:</span><span>NT$${goal.targetAmount.toLocaleString()}</span></div>`;
                html += `<div class="goal-item"><span>ç•¶å‰é€²åº¦:</span><span>NT$${goal.currentAmount.toLocaleString()}</span></div>`;
                html += `<div class="goal-item"><span>å®Œæˆåº¦:</span><span>${goal.progress}%</span></div>`;
                html += `<div class="goal-item"><span>å‰©é¤˜æ™‚é–“:</span><span>${goal.timeRemaining}å€‹æœˆ</span></div>`;
                html += '</div>';
                html += '</div>';
            });
            
            return html;
        }

        function closeModal() {
            document.getElementById('goalModal').style.display = 'none';
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', function() {
            setTimeout(checkBasicFunction, 500);
        });
    </script>
</body>
</html>
